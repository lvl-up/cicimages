#!/usr/bin/env bash

CURRENT_PATH="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
# shellcheck source=support/bin/sh/functions/cic.sh
source "${CURRENT_PATH}/sh/functions/cic.sh"

# shellcheck source=support/bin/sh/functions/utils.sh
source "${CURRENT_PATH}/sh/functions/utils.sh"

# shellcheck source=support/bin/sh/checksum.sh
source "${CURRENT_PATH}/sh/checksum.sh"

check_required_enviroment_is_set

cic_command="$(bootstrap_cic_environment) TRACKS_PATH=/cic/tracks EXERCISES_PATH=/cic/exercises rbenv exec cic"

options=""
subcommand=$1

if [ "${subcommand}" == "track" ]; then
    command="${cic_command} $*"
else

    if [ "${subcommand}" == "connect" ]; then
        options='-it'
    fi

    image=$2
    switch=$3
    container_command=$4

    command="${cic_command} ${subcommand} ${image} ${switch}"

    if [ "${container_command}" != "" ]; then
        command="${command} '${container_command}'"
    fi
fi

mounts=($(docker_mounts))
docker run ${options} -t \
    --network "$(cic_network)" \
    ${mounts[@]} \
    -w "$(cic_working_dir)" \
    "$(cic_image)" \
    /bin/bash -c "${command}"
